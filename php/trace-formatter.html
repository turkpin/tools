<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>PHP Trace Formatter</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/vs.min.css" />
        <style>
            pre code.hljs {
                padding: 0;
            }
        </style>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/languages/json.min.js"></script>
    </head>
    <body class="bg-slate-100">
        <div class="container2 mx-auto p-4">
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <div>trace string</div>
                    <textarea
                        id="input"
                        class="resize w-full h-[70vh] p-2"
                        spellcheck="false"
                        placeholder="#0 /app/controllers/..."
                    ></textarea>
                </div>
                <div>
                    <div>json</div>
                    <div class="resize w-full h-[70vh] overflow-auto p-2 bg-white text-sm" id="output"></div>
                </div>
            </div>
        </div>

        <script>
            let inputEl = document.getElementById("input");
            let outputEl = document.getElementById("output");

            inputEl.addEventListener("input", format);

            function format() {
                let input = inputEl.value;
                let entries = parseTraceString(input);
                let output = JSON.stringify(entries, null, 4);
                output = stripslashes(output);
                output = stripslashes(output);
                outputEl.innerHTML = `
                    <pre><code class="language-json min-w-max">${output}</code></pre>
                `;
                hljs.highlightAll();
                inputEl.value = buildTraceString(entries);
            }

            function stripslashes(str) {
                return str.replace(/\\\\/g, "\\");
            }

            function parseTraceString(traceString) {
                let entries = [];
                let lines = traceString.split(/\\n/g);
                for (let line of lines) {
                    line = line.trim();
                    if (line.length === 0) {
                        continue;
                    }
                    let entry = parseTraceLine(line);
                    entries.push(entry);
                }
                return entries;
            }

            function parseTraceLine(line) {
                let entry = {
                    index: null,
                    file: null,
                    line: null,
                    call: null,
                };
                let parts = line.split(" ");
                entry.index = parts[0].replace("#", "");
                entry.file = parts[1].split("(")[0];
                let lineMatch = parts[1].match(/\((\d+)\)/);
                if (lineMatch) {
                    entry.line = lineMatch[1];
                }
                entry.call = parts.slice(2).join(" ");
                return entry;
            }

            function buildTraceString(entries) {
                let lines = [];
                for (let entry of entries) {
                    let parts = [`#${entry.index}`, `${entry.file}`];
                    if (entry.line) {
                        parts[1] += `(${entry.line})`;
                    }
                    if (entry.call) {
                        parts.push(entry.call);
                    }
                    let line = parts.join(" ");
                    lines.push(line);
                }
                return lines.join("\n");
            }
        </script>
    </body>
</html>
