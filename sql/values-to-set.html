<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>SQL Values to SET</title>
        <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    </head>

    <body class="bg-gray-800 text-white">
        <h1 class="text-2xl font-semibold p-4">INSERT query to SET query</h1>

        <div class="flex p-4 gap-4">
            <div class="w-2/5">
                <h1 class="text-xl font-semibold mb-1">Insert Query</h1>
                <textarea
                    id="insertQuery"
                    class="w-full h-[80vh] p-2 border border-gray-300/25 rounded-lg bg-white/5 font-mono"
                    placeholder="INSERT INTO `table` (`field_1`, ...) VALUES ('value_1', ...);"
                    autofocus
                ></textarea>
            </div>
            <div class="w-2/5">
                <h1 class="text-xl font-semibold mb-1">Set Query</h1>
                <textarea
                    id="setQuery"
                    class="w-full h-[80vh] p-2 border border-gray-300/25 rounded-lg bg-white/5 font-mono"
                    placeholder="INSERT INTO `table` SET `field_1` = 'value_1', ...;"
                ></textarea>
            </div>
            <div class="w-1/5">
                <h1 class="text-xl font-semibold mb-1">Table Description</h1>
                <textarea
                    id="tableDescBox"
                    class="w-full h-[80vh] p-2 border border-gray-300/25 rounded-lg bg-white/5 font-mono"
                    placeholder="Result of 'DESCRIBE table;'"
                ></textarea>
            </div>
        </div>

        <script>
            const insertQueryEl = document.getElementById("insertQuery");
            const setQueryEl = document.getElementById("setQuery");
            const tableDescBox = document.getElementById("tableDescBox");

            insertQueryEl.addEventListener("input", () => {
                const insertQuery = insertQueryEl.value.trim();
                let output = "";
                if (insertQuery) {
                    try {
                        output = convertInsertToSet(insertQuery);
                    } catch (error) {
                        output = error.message;
                    }
                }
                setQueryEl.value = output;
            });

            function convertInsertToSet(query) {
                const regex = /INSERT INTO\s+`(?<table>[^`]+)`\s+\((?<fields>[^)]+)\)\s+VALUES\s+\((?<values>[^)]+)\)/;
                const match = query.match(regex);
                if (!match) {
                    throw new Error("Invalid INSERT query format.");
                }
                let { table, fields, values } = match.groups;
                fields = fields.split(",").map((col) => col.trim());
                values = values.split(",").map((val) => val.trim());
                let setQuery = `INSERT INTO\n    \`${table}\`\nSET\n`;
                for (let i = 0; i < fields.length; i++) {
                    const field = fields[i];
                    const value = values[i];
                    const formattedValue = value === "NULL" ? "NULL" : `${value}`;
                    setQuery += `    ${field} = ${formattedValue},\n`;
                }
                setQuery = setQuery.slice(0, -2) + ";";
                return setQuery;
            }

            function parseTableDescription(desc) {
                let structure = [];
                let lines = desc.split("\n");
                for (let line of lines) {
                    let fieldDef = buildFieldDefFromLine(line);
                    structure.push(fieldDef);
                }
                return structure;
            }

            function buildFieldDefFromLine(line) {
                let parts = line.trim().split(/\s+/); // 4, 5, 6, or 7 parts
                let field = parts.shift();
                let type = parts.shift();
                var nextPart = parts.shift();
                if (nextPart == "unsigned") {
                    type += " unsigned";
                } else {
                    parts.unshift(nextPart);
                }
                let null_str = parts.shift() == "YES";
                let keys = ["PRI", "UNI", "MUL"];
                let key = null;
                var nextPart = parts.shift();
                if (keys.includes(nextPart)) {
                    key = nextPart;
                } else {
                    parts.unshift(nextPart);
                }
                let default_str = parts.shift();
                if (default_str === "NULL") {
                    default_str = null;
                }
                let extra = parts.join(" ");
                let fieldDef = {
                    Field: field,
                    Type: type,
                    Null: null_str,
                    Key: key,
                    Default: default_str,
                    Extra: extra,
                };
                return fieldDef;
            }
        </script>
    </body>
</html>
